## P3-F01 — DIRECTOR (strategic intelligence)
status: META
owner: system
req_type: FUNCTIONAL
phase: runtime
area: DIRECTOR
priority: H
labels: [director, direction, new]
rationale: A top-level director persona sets goals for the world, brokers AI/solver insight, and injects directives into downstream decision states so the experience matches design intent while remaining deterministic.
acceptance:
  - The director ingests configuration and world state to define overall objectives (e.g., level theme, challenge pacing, resource distribution).
  - Director decisions are expressed as actionable directives for downstream personas (configurator, actors) without duplicating their responsibilities.
  - The director provides structured decision hooks to configurator planning and actor evaluation states, including priority channels, timeouts, and conflict-resolution rules.
  - The director maintains an integration contract for higher-order intelligence sources (LLMs, knowledge bases) capturing prompts, structured JSON responses (theme, hazards, pacing, actor quotas, recommended actor archetypes), confidence, and deterministic replay data.
  - Strategic guidance is decomposed inside the simulation boundary: the director ingests orchestrator-issued capability packages (themes, tokenized upgrades/shards, AIU recommendations) and selects AIU combinations (“lego” behaviours) of varying sophistication per actor archetype so configurator can provision drones, specialists, or elites that match the stated intent without reaching back into external services.
  - The director maintains an authoritative catalogue of available assets (AIUs, shards/upgrades, known actor archetypes) and shares this inventory with the orchestrator so both personas derive decisions from the same capability set; missing assets trigger deterministic fallbacks.
  - Scenario planning is kick-started by a handshake with the orchestrator: the director receives the capability envelope, synthesises the initial blueprint/actor plan, acknowledges the assets consumed, and records the resulting configuration/budget snapshot for replay.
  - The director configures supported solvers (e.g., Z3) with domain constraints, invokes them when deterministic reasoning is required, and interprets results into directives.
  - Actor behaviours are layered: the director assigns AIU stacks (logical reasoning) while ensuring every actor retains a deterministic instinct fallback (basic movement/hold routines) that can be invoked whenever AIU modules fail or are rejected.
  - Level planning honours the same fallback philosophy: when AI-assisted planning is unavailable or produces invalid results, the director emits a deterministic baseline layout (e.g., seeded barriers, default corridors) and flags that the run is using the fallback plan.
  - Directives include provenance: why the decision was made, what inputs were considered (AI, solver, telemetry), and how success should be measured.
  - When AI/solver inputs fail or return inconclusive results, the director falls back to declared base heuristics before yielding control to the logic engine.
verification:
  - review: design walkthrough shows example directives, their provenance, and how they align with overall goals.
traces:
  code: []

## P3-F02 — DIRECTOR ADAPTATION (dynamic intelligence)
status: META
owner: system
req_type: FUNCTIONAL
phase: runtime
area: DIRECTOR
priority: M
labels: [director, adaptation, new]
rationale: As the simulation evolves, the director persona must adapt goals, modify plans, or request new blueprints based on observed outcomes.
acceptance:
  - The persona monitors telemetry from layout, actors, solver verdicts, and AI confidence to detect when goals are met, threatened, or need adjustment.
  - Adjustments are issued through clearly defined director patches so downstream systems remain deterministic.
  - The director evaluates AI/solver outputs for freshness, confidence, and contradiction before promoting them to directives or discarding them.
  - Adaptations maintain audit trails, including triggers, chosen intelligence sources, fallbacks engaged, and the intended effect, so designers can review changes.
  - If adaptation pipelines (AI or solver) are unavailable or refuse to act, the system acknowledges the gap, records the failure, invokes base heuristics where possible, and allows the logic engine to continue driving behaviour.
verification:
  - unit/integration: controlled scenarios drive the persona to issue patches when milestones fail or succeed.
traces:
  code: []

## P3-F05 — DIRECTOR GUIDANCE BROKERAGE (AI-assisted intent generation)
status: META
owner: system
req_type: FUNCTIONAL
phase: runtime
area: DIRECTOR.GUIDANCE
priority: M
labels: [director, guidance, llm, solver]
rationale: The director must gather higher-order guidance from AI and solver services, interpret the results, and package them as deterministic directives for configurator and actor personas.
acceptance:
  - Guidance requests include layout context, desired goals, deterministic seeds, and provenance hashes so external responses can be audited or replayed deterministically.
  - Responses from AI/solver services are validated against a structured JSON schema (theme, hazard emphasis, actor density, narrative cues, layout blueprint, actor recommendations) and annotated with confidence metrics before being staged as directives.
  - Layout blueprint requests encode user-supplied parameters (width, height, actor count, barrier budget, difficulty) and require Ollama (or the configured AI endpoint) to return a JSON template describing rooms, hallways, start/end flow, solver constraints, and suggested actor/AIU loadouts.
  - When AI-level planning fails validation or the AI channel is unavailable, the director emits a deterministic fallback layout (randomly seeded barriers within constraints, default corridors) and marks the blueprint as “fallback” so downstream personas know higher-order guidance was unavailable.
  - Actor recommendations specify factions, spawn zones, AIU template ids (single or composite behaviours), shard/upgrades to apply, expected costs, and confidence; the director validates each entry against the AIU registry, shard inventory, and available budgets before forwarding to configurator or logic engine, relying solely on the orchestrator-provided capability envelopes instead of calling external services directly.
  - The director enforces economic rules: every investment (AIU, shard, layout adjustment) is debited from the active scenario budget; it monitors cumulative spend, rejects overspend attempts, and produces the ledger snapshots the orchestrator needs for external auditing (and future PvP budgeting when player/AI factions share the economy).
  - Escalation triggers back to the orchestrator are explicit: (a) capability gap—an AIU or shard requested by the strategy is missing, (b) budget refresh—external events modify faction budgets (e.g., blockchain purchases), (c) blueprint invalidation—solver/telemetry proves the current plan is non-viable beyond tolerance, or (d) user-driven interventions (future PvP). Routine actor reasoning (solver SAT/UNSAT, AIU fallback) does **not** trigger escalation.
  - The director rejects malformed blueprint responses (missing rooms, disconnected flow, unknown AIUs, budget overruns, schema violations) and logs provenance (model identity, prompt checksum, deterministic seed) before re-issuing or falling back to heuristics.
  - The director caches responses, stores metadata (model identity, prompt summary, checksums, budget ledger snapshots), and records fallback actions when services fail or return invalid data.
  - When AI/solver pipelines are unavailable, the director records the failure, emits a fallback directive (heuristic plan), and notifies downstream personas that a lower tier was used.
verification:
  - unit/integration: simulated AI/solver responses (success and failure) confirm schema validation, caching, and fallback behaviour operate as expected.
traces:
  code: []

## P3-F05_1 — LAYOUT BLUEPRINT SCHEMA
status: proposed
owner: system
req_type: FUNCTIONAL
phase: runtime
area: DIRECTOR.GUIDANCE
priority: M
labels: [director, blueprint, schema]
rationale: Downstream personas require a predictable structure for AI-authored layout blueprints so they can deterministically build surfaces, evaluate solvability, and iterate when plans fail.
acceptance:
  - The director maintains a versioned JSON schema for layout blueprints including: rooms (id, bounds, walkable flag), connectors (hallway edges, directionality), anchor hints (start/end ordering), optional thematic tags, solver constraints (required traversals, forbidden zones), and actor recommendations (group labels, counts, spawn intents, AIU template ids, per-group budget).
  - Blueprint responses include confidence scores, deterministic replay tokens (model name, prompt hash, response hash), a suggested progression flow (sequence of room ids from start to end), and an AIU budget ledger (total cost vs. remaining).
  - The schema must support blueprint revisions: configurator rejection messages identify failed constraints or AIU violations, and the director re-prompts the AI with structured feedback to produce an updated blueprint.
  - Documentation includes sample blueprints, validation rules, AIU registry references, and fallbacks for missing sections so the configurator can degrade gracefully when optional fields are absent.
verification:
  - review: schema file and example payloads demonstrate coverage of required fields; integration tests confirm invalid blueprints are rejected and valid ones pass.
traces:
  code: []

## P3-F05_2 — AIU TEMPLATE BUDGETING
status: proposed
owner: system
req_type: FUNCTIONAL
phase: runtime
area: DIRECTOR.GUIDANCE
priority: M
labels: [director, aiu, budgeting]
rationale: Actor motivation packages are treated as modular AIU templates that must respect scenario budgets and deterministic replay.
acceptance:
  - The director maintains an AIU registry (id, cost, version, prerequisites) shared with configurator and actors.
  - Guidance requests declare available AIU templates and remaining budget so AI services only propose valid combinations.
  - Blueprint responses include per-group AIU cost summaries; the director debits the budget ledger when accepting recommendations and records provenance (model identity, reasoning) for later audits.
  - When solutions exceed budgets or reference unavailable AIUs, the director either downgrades the recommendation (fallback AIUs) or rejects the blueprint with structured feedback.
  - Budget state (spent, remaining, fallback usage) is surfaced to telemetry and can be replayed deterministically.
verification:
  - unit/integration: simulated AI responses that overspend or use unknown AIUs trigger rejections; valid plans update the budget ledger and expose telemetry.
traces:
  code: []

## P3-F06 — DIRECTOR DIRECTIVE ISSUE (patch publishing)
status: META
owner: system
req_type: FUNCTIONAL
phase: runtime
area: DIRECTOR.GUIDANCE
priority: M
labels: [director, directives, patches]
rationale: After generating guidance, the director must emit structured directives/patches for configurator and actor personas, including provenance and confidence information.
acceptance:
  - Each directive carries a unique id, schema version, confidence score, and provenance references (prompt summary, solver settings) so downstream personas can validate and log usage.
  - Directives specify intended targets (e.g., configurator plan adjustments, actor behaviour hints) and include guard-rail hints (required constraints, fallback recommendations).
  - The director maintains an outbox/acknowledgement workflow: directives remain pending until configurator acknowledges acceptance/rejection, and replays or rescinds directives when necessary.
  - The director exposes APIs for the coordinator/moderator to query pending directives and audit their lifecycle.
verification:
  - unit/integration: publishing sample directives shows correct metadata, acknowledgement tracking, and rejection handling.
traces:
  code: []

## P3-F03 — LOGIC ENGINE (tactical intelligence)
status: META
owner: system
req_type: FUNCTIONAL
phase: runtime
area: LOGIC
priority: H
labels: [logic, reasoning, new]
rationale: Tactical reasoning converts director directives into concrete actions, such as assigning movement scripts or choosing responses to observations.
acceptance:
  - The logic engine consumes director directives and world state to produce deterministic actions for specific actors or modules.
  - Actions respect constraints exposed by other personas (e.g., configurator enterability, actor stamina) without duplicating validations.
  - The engine exposes a clear input/output contract so modules can request reasoning outcomes on demand.
  - When no director directive is present, the logic engine drives behaviour autonomously using its rules and reports that it is operating in fallback mode.
verification:
  - unit: scenario fixtures feed directives and world state, producing expected tactical outputs.
traces:
  code: []

## P3-F04 — LOGIC EXECUTION FEEDBACK
status: META
owner: system
req_type: FUNCTIONAL
phase: runtime
area: LOGIC
priority: M
labels: [logic, feedback, new]
rationale: Tactical logic must evaluate whether issued actions achieved their goals and inform the director layer.
acceptance:
  - The logic engine tracks execution results, success/failure, and anomalies for each action or decision.
  - Feedback is fed upstream to the director so goals can be adjusted when necessary.
  - Logging includes enough context (inputs, outputs, observed outcomes) for post-run analysis.
  - If the logic engine is unavailable, a basic instinct layer executes simple heuristics (e.g., first available move or random defensive choice) and marks feedback accordingly for higher layers to review.
verification:
  - unit/integration: simulated runs demonstrate recording of successes/failures and forwarding of feedback.
traces:
  code: []
